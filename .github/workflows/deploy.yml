name: BEE-IT HIVE Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  orchestrate-deployment:
    name: Build and Force Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Branch Reset & Environment Preparation
        run: |
          echo "Process: Cleaning environment and preparing deploy branch"
          git config --global user.name "BEE-IT HIVE Automation"
          git config --global user.email "bee-it.hive@gandakiuniversity.edu.np"
          
          # Remove remote deploy branch to ensure a clean slate every push
          git push origin --delete deploy || echo "Branch deploy did not exist"
          git checkout -b deploy
        shell: bash

      - name: Infrastructure Installation & Telemetry
        run: |
          mkdir -p logs
          echo "Timestamp: $(date)" > logs/install_telemetry.log
          echo "Node Version: $(node -v)" >> logs/install_telemetry.log
          echo "Process: Running NPM Install..."
          npm install >> logs/install_telemetry.log 2>&1
        shell: bash

      - name: Development Validation
        run: |
          echo "Process: Running development-mode build test..."
          npx vite build --mode development >> logs/dev_test_telemetry.log 2>&1
        shell: bash

      - name: Production Compilation
        run: |
          echo "Process: Executing final production build..."
          npm run build >> logs/production_build.log 2>&1
          echo "Process: Cataloging build structure..."
          ls -R dist/ > logs/structure_telemetry.log
        shell: bash

      - name: Vite GitHub Pages Deployer
        uses: skywarth/vite-github-pages-deployer@v1.5.0
        with:
          build_path: ./dist
          package_manager: npm
          artifact_name: github-pages
          debug_mode: true

      - name: Synchronize Build & Telemetry to Deploy Branch
        run: |
          # Integrate telemetry into production directory
          cp -r logs/ dist/logs/
          
          # Initialize and force push the distribution folder
          cd dist
          git init
          git config --global user.name "BEE-IT HIVE Automation"
          git config --global user.email "bee-it.hive@gandakiuniversity.edu.np"
          git checkout -b deploy
          git add .
          git commit -m "deploy: stable production build - $(date +'%Y-%m-%d %H:%M:%S') [skip ci]"
          git push --force "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" deploy
        shell: bash
